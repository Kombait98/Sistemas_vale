<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
@media print {
    .navbar, .btn, .card, .alert, .mb-5 {
        display: none !important; /* Esconde tudo que não é a tabela ao imprimir */
    }
    .table {
        width: 100% !important;
        border: 1px solid #000;
    }
}
</style>
    <title>Conferência de Valores - Vales</title>
</head>
<body class="container-fluid mt-1">
    
    <%- include('../partials/navbar') %>

    <div class="container mt-4">
        <h2 class="mb-4">Conferência de Valores</h2>

        <div class="card mb-4 shadow-sm">
    <div class="card-body bg-light">
        <form action="/vales/relatorio" method="GET" class="row g-3" id="formFiltro">
            <div class="col-md-4">
                <label class="form-label font-weight-bold">Filtrar por Usuário</label>
                <select name="usuario" class="form-select">
                    <option value="">Todos os Colaboradores</option>
                    <% usuarios.forEach(u => { %>
                        <option value="<%= u.nome %>" <%= filtroUsuario === u.nome ? 'selected' : '' %>>
                            <%= u.nome %>
                        </option>
                    <% }) %>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label font-weight-bold">Filtrar por Mês</label>
                <input type="month" name="mes" class="form-control" value="<%= filtroMes %>">
            </div>
            <div class="col-md-4 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-filter"></i> Filtrar
                </button>
                
                <button type="button" onclick="exportarCSV()" class="btn btn-success w-100">
                    Baixar Report 
                </button>

                <a href="/vales/relatorio" class="btn btn-outline-secondary">Limpar</a>
            </div>
        </form>
    </div>
</div>

        <div class="table-responsive shadow-sm rounded">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Usuário</th>
                        <th>Data</th>
                        <th>Trajeto</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <% registros.forEach(r => { %>
                        <tr class="<%= r.pago === 1 ? 'table-success' : '' %>"> 
                            <td><strong><%= r.usuario %></strong></td>
                            <td><%= r.data %></td>
                            <td>
                                <%= r.nome_saida %> <i class="bi bi-arrow-right text-muted"></i> <%= r.nome_chegada %>
                                <% if (r.motivo) { %>
                                    <i class="bi bi-chat-right-text text-info ms-1" 
                                       style="cursor: pointer;"
                                       data-bs-toggle="tooltip" 
                                       data-bs-placement="top"
                                       title="<%= r.motivo %>"></i>
                                <% } %>
                            </td>
                            <td><strong>R$ <%= r.total_linha.toFixed(2) %></strong></td>
                            <td>
                                <% if (r.pago === 1) { %>
                                    <span class="badge bg-success"><i class="bi bi-check-all"></i> Pago</span>
                                <% } else { %>
                                    <span class="badge bg-warning text-dark"><i class="bi bi-hourglass-split"></i> Pendente</span>
                                <% } %>
                            </td>
                            <td class="text-center">
                                <form action="/vales/alternar-pagamento/<%= r.id %>" method="POST">
                                    <button type="submit" class="btn btn-sm <%= r.pago === 1 ? 'btn-outline-secondary' : 'btn-success' %> w-100">
                                        <%= r.pago === 1 ? 'Estornar' : 'Confirmar Pagamento' %>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    <% }) %>
                    <% if (registros.length === 0) { %>
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">Nenhum registro autorizado encontrado para estes filtros.</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>

        <div class="row mt-4 g-3">
            <div class="col-md-4">
                <div class="card border-primary shadow-sm h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted text-uppercase small">Total do Período</h6>
                        <h3 class="text-primary mb-0">R$ <%= totalGeral.toFixed(2) %></h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-success shadow-sm h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted text-uppercase small">Total Pago</h6>
                        <h3 class="text-success mb-0">R$ <%= totalPago.toFixed(2) %></h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-danger shadow-sm h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted text-uppercase small">Ainda Pendente</h6>
                        <h3 class="text-danger mb-0">R$ <%= totalPendente.toFixed(2) %></h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-5 mb-5">
            <a href="/vales" class="btn btn-secondary shadow-sm">
                <i class="bi bi-arrow-left"></i> Voltar ao Cadastro
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Inicialização dos Tooltips
        function exportarCSV() {
        // Pega os valores atuais dos filtros
        const form = document.getElementById('formFiltro');
        const usuario = form.usuario.value;
        const mes = form.mes.value;

        // Redireciona para a rota de exportação com os parâmetros
        window.location.href = `/vales/relatorio/exportar?usuario=${usuario}&mes=${mes}`;
    }
        document.addEventListener('DOMContentLoaded', function () {
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
        });

    </script>
</body>
</html>